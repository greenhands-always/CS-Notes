在《数据库系统概念》书中，介绍了五种实现 Join 运算符的算法。
# 1 嵌套循环连接
![](https://obsidian-notes-of-huangyh.oss-cn-hangzhou.aliyuncs.com/img/20230213114411.png)

嵌套循环连接算法（nested-loop join）的代价很大，因为该算法逐个检查两个关系中的每一对元组。
如果其中一个关系能完全放在内存中，那么把这个关系作为内层关系来处理是有好处的。这给查询优化提供了一个方案。

# 2 块嵌套循环连接
因缓冲区太小而内存不能完全容纳任何一个关系时，如果我们以块的方式而不是以元组的方式处理关系，仍然可以减少不少块读写次数。图12-6所示过程是块嵌套循环连接 (blocknested-loop join), 它是嵌套循环连接的一个变种，其中内层关系的每一块与外层关系的每一块形成一对。在每个块对中，一个块中的每一个元组与另一块的每一元组形成元组对，得到全体元组对。和前面一样，把满足连接条件的所有元组对添加到结果中。  %%[322页](bookxnotepro://opennote/? nb={c99b0202-1308-4335-acc3-f0dd1e5bc7cc}&book=7a0a8f7d2262490080890f4e7c4f5ca2&page=321&x=189&y=278&id=1198&uuid=631978c22f9ddfcf18c4cfe893c3e871)%%
块嵌套循环连接与基本的嵌套循环连接算法代价的主要差别在于：在最坏的情况下，对于外层关系中的每一个块，内层关系 s 的每一块只须读一次，而不是对外层关系的每一个元组读一次。因此，在最坏的情况下，共需 br `*` bs,+b，次块传输，这里 br 和 bs 分别代表含有关系 r 和 s 中元组的磁盘块数。对内层关系的每一次扫描需要一次磁盘搜索，对外层关系的扫描需要每块一次磁盘搜索，这样总共是2br 次磁盘搜索。显然，如果内存不能容纳任何一个关系，则使用较小的关系作为外层关系更有效。在最好的情况下，内存能够容纳内层关系，需要 b,+b，次块传输加上两次磁盘搜索（在这种情况下我们把较小的关系作为内层关系）。 %%[322页](bookxnotepro://opennote/? nb={c99b0202-1308-4335-acc3-f0dd1e5bc7cc}&book=7a0a8f7d2262490080890f4e7c4f5ca2&page=321&x=198&y=448&id=1199&uuid=40e12edf0463ab784718576f9ce07c83)%%
## 2.1 嵌套循环与块嵌套循环算法的性能可以进一步地改进：
- 如果自然连接或等值连接中的连接属性是内层关系的码，则对每个外层关系元组，内层循环一旦找到了首条匹配元组就可以终止。
- 在块嵌套循环连接算法中，外层关系可以不用磁盘块作为分块的单位，而以内存中最多能容纳的大小为单位，当然同时要留出足够的缓冲空间给内层关系及输出结果使用。也就是说，如果内存有 M 块，我们一次读取外层关系中的 M-2块，当我们读取到内层关系中的每一块时，我们把它与外层关系中的所有 M-2块做连接。这种改进使内层关系的扫描次数从 b，次减少到 `[br/ (M-2) ] ` 次，这里的 b，是外层关系所占的块数。这样全部代价为 `[br/(M-2) * bs +br] ` 次块传输和 `2「br/(M-2)]` 次磁盘搜索。
- 对内层循环轮流做向前、向后的扫描。该扫描方法对磁盘块读写请求进行排序，使得上一次扣描时留在缓冲区中的数据可以重用，从而减少磁盘存取次数。
- 若内层循环的连接属性上有索引，可以用更有效的索引查找法替代文件扫描法。

# 3 索引嵌套循环连接
若在内层循环的连接属性上有索引，则可以用索引查找替代文件扫描。对于外层关系 r 的每一个元组 tr，可以利用索引查找 s 中和元组 tr 满足连接条件的元组。上述连接方法称为索引嵌套循环连接 (indexednested-loop join)，它可以在已有索引或者为了计算该连接而专门建立临时索引的情况下使用。

# 4 归并算法
归并连接算法如图12-7所示。在这个算法中，JoinAtrrs 表示 R∩S 中的属性；tr 与 ts 自然连接表示具有相同属性值的两个元组 tr、ts 的拼接，接着通过投影去除其中重复的属性。归并连接算法为每个关系分配一个指针。这些指针一开始指向相应关系的第一个元组。随着该算法的进行，指针遍历整个关系。一个关系中在连接属性上具有相同值的一组元组被读入到 Ss 中。算法要求每个 Ss，元组集合都能装入主存；本节稍后将讲述如何扩展该算法以避免这一限制。接下来，另一关系中相应的元组（如果有的话）被读人，并在读入的同时加以处理。
 ![](https://obsidian-notes-of-huangyh.oss-cn-hangzhou.aliyuncs.com/img/20230213155704.png)
# 5 散列连接
散列连接算法背后的思想如下。如果关系 r 的一个元组与关系 s 的一个元组满足连接条件，那么它们在连接属性上就会有相同的值。若该值经散列函数映射到“则关系 r 的那个元组必在 r, 中，而关系 s 的那个元组必在 si 中。因此，ri 中的元组 r 只需要与 si 中的元组 s 相比较，而没有必要与其他任何划分里的元组 s 相比较。 %%[326页](bookxnotepro://opennote/? nb={c99b0202-1308-4335-acc3-f0dd1e5bc7cc}&book=7a0a8f7d2262490080890f4e7c4f5ca2&page=325&x=119&y=244&id=1216&uuid=1c6c7e30ece5403b875c49c2cfc1d6e3)%%
